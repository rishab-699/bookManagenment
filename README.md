### **Project Documentation: Book Management System**

---

## **Overview**

The Book Management System is designed to manage book transactions, user data, and rent calculations. The system contains three primary collections: `books`, `users`, and `booktransactions`. These collections track the details of available books, user data, and the issuance or return of books, including rent calculations. The system enables the management of book transactions such as issuing books, returning them, calculating rent, and maintaining a record of all past and current transactions.

---

## **Technologies Used**

- **Backend**: Node.js, Express.js, Mongoose (MongoDB ORM)
- **Database**: MongoDB (NoSQL)
- **Frontend**: React.js (Optional for rendering UI)
- **HTTP Client**: Axios (for sending HTTP requests from the frontend)
- **Version Control**: Git

---

## **Collections**

### 1. **Books Collection (`books`)**

**Schema:**

```js
const booksSchema = new mongoose.Schema({
    book_name: {
        type: String,
        required: true
    },
    category: {
        type: String,
        required: true
    },
    rent_per_day: {
        type: Number,
        required: true
    }
});
```

- `book_name`: The name of the book.
- `category`: The category of the book (e.g., fiction, non-fiction).
- `rent_per_day`: The rental cost of the book per day.

---

### 2. **Users Collection (`users`)**

**Schema:**

```js
const usersSchema = new mongoose.Schema({
    user_name: {
        type: String,
        required: true
    },
    userId: {
        type: String,
        unique: true,
        required: true
    },
    email: {
        type: String,
        required: true
    }
});
```

- `user_name`: The name of the user.
- `userId`: A unique identifier for the user.
- `email`: Email address of the user.

---

### 3. **Book Transactions Collection (`booktransactions`)**

**Schema:**

```js
const bookTransactionSchema = new mongoose.Schema({
    book_id: {
        type: mongoose.Schema.Types.ObjectId,
        ref: 'books',
        required: true
    },
    userId: {
        type: String,
        required: true
    },
    issuedate: {
        type: Date,
        required: true
    },
    returndate: {
        type: Date
    },
    totalRent: {
        type: Number
    }
});
```

- `book_id`: References the ID of the book from the `books` collection.
- `userId`: References the ID of the user from the `users` collection.
- `issuedate`: The date the book was issued.
- `returndate`: The date the book was returned (null if the book has not yet been returned).
- `totalRent`: The total rent generated for the transaction.

---

## **Functionalities**

### **1. Issuing a Book**

- When a book is issued to a user, an entry is created in the `booktransactions` collection with the `book_id`, `userId`, and `issuedate`.
- Initially, the `returndate` is `null`.

**Endpoint:**

```http
POST /api/transaction/issue
```

**Sample Request Body:**

```json
{
  "book_id": "66f6a2cd21f51da5ed2e1ff1",
  "userId": "0001",
  "issuedate": "2024-09-28"
}
```

### **2. Returning a Book**

- When a user returns a book, the `returndate` is updated, and the total rent is calculated based on the difference between `issuedate` and `returndate` multiplied by the `rent_per_day` of the book.

**Endpoint:**

```http
PUT /api/transaction/return/:id
```

**Sample Request Body:**

```json
{
  "returndate": "2024-10-01"
}
```

### **3. Calculating Rent**

- Rent is calculated by multiplying the difference between the `returndate` and `issuedate` by the `rent_per_day` of the book.

---

## **API Endpoints**

### **1. Get All Transactions for a User**

**Description**: Retrieves a list of all books (both returned and not returned) issued to a particular user.

**Query**: Fetch the books issued to a specific user within a date range.

**Endpoint:**

```http
GET /api/transaction/user/:userId
```

**Aggregate Query Example:**

```js
db.booktransactions.aggregate([
    {
        $match: {
            userId: "0001", // Replace with the userId
            issuedate: { $gte: new Date("2024-01-01"), $lte: new Date("2024-12-31") }
        }
    },
    {
        $lookup: {
            from: "books",
            localField: "book_id",
            foreignField: "_id",
            as: "bookInfo"
        }
    },
    {
        $lookup: {
            from: "users",
            localField: "userId",
            foreignField: "userId",
            as: "userInfo"
        }
    },
    {
        $project: {
            bookName: { $arrayElemAt: ["$bookInfo.book_name", 0] },
            userName: { $arrayElemAt: ["$userInfo.user_name", 0] },
            issuedate: 1,
            returndate: 1
        }
    }
]);
```

### **2. Get Total Rent Generated by a Book**

**Description**: Fetches total rent generated, along with the count of past and present issues of a specific book.

**Endpoint:**

```http
GET /api/book/:bookId/rent
```

**Sample Aggregation Query:**

```js
db.booktransactions.aggregate([
    {
        $match: { book_id: ObjectId("66f6a2cd21f51da5ed2e1ff1") }
    },
    {
        $facet: {
            totalPastIssues: [
                { $match: { returndate: { $ne: null } } },
                { $count: "totalPastIssues" }
            ],
            totalPresentIssues: [
                { $match: { returndate: null } },
                { $count: "totalPresentIssues" }
            ],
            totalRentGenerated: [
                { $match: { returndate: { $ne: null } } },
                { $group: { _id: null, totalRent: { $sum: "$totalRent" } } },
                { $project: { _id: 0, totalRent: 1 } }
            ]
        }
    },
    {
        $project: {
            totalPastIssues: { $arrayElemAt: ["$totalPastIssues.totalPastIssues", 0] },
            totalPresentIssues: { $arrayElemAt: ["$totalPresentIssues.totalPresentIssues", 0] },
            totalRentGenerated: { $arrayElemAt: ["$totalRentGenerated.totalRent", 0] }
        }
    }
]);
```

### **3. Update Transaction (Return Book)**

**Description**: Updates a transaction when a book is returned, including setting the `returndate` and calculating the total rent.

**Endpoint:**

```http
PUT /api/transaction/return/:id
```

**Sample Request Body:**

```json
{
  "returndate": "2024-10-01"
}
```

---

## **Example Queries**

### **1. List All Issued Books Between Given Dates**

**Description**: Fetch a list of books (both returned and not returned) issued between specific dates.

**Sample Query**:

```js
db.booktransactions.aggregate([
    {
        $match: {
            issuedate: { $gte: new Date("2024-09-01"), $lte: new Date("2024-09-30") }
        }
    },
    {
        $lookup: {
            from: "books",
            localField: "book_id",
            foreignField: "_id",
            as: "bookInfo"
        }
    },
    {
        $lookup: {
            from: "users",
            localField: "userId",
            foreignField: "userId",
            as: "userInfo"
        }
    },
    {
        $project: {
            bookName: { $arrayElemAt: ["$bookInfo.book_name", 0] },
            userName: { $arrayElemAt: ["$userInfo.user_name", 0] },
            issuedate: 1,
            returndate: 1
        }
    }
]);
```

---

## **Conclusion**

This Book Management System allows users to efficiently track the issuance and return of books, calculate rental costs, and maintain a record of all transactions. The use of MongoDB's aggregation framework provides flexible and efficient querying capabilities for real-time data needs. This documentation serves as a guide to the system's design, functionalities, and example queries for managing book transactions and tracking rental information.
